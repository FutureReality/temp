DELIMITER $$

CREATE TRIGGER after_update_ticket
AFTER UPDATE ON Tickets
FOR EACH ROW
BEGIN
  DECLARE cliente_email VARCHAR(255);

  IF NEW.estado = 'Cerrado' AND OLD.estado != 'Cerrado' THEN
    SELECT email INTO cliente_email
    FROM Clientes
    WHERE id_cliente = NEW.id_cliente;

    INSERT INTO pending_mails (email, subject, message, sent)
    VALUES (
      cliente_email,
      CONCAT('Ticket ', NEW.id_ticket),
      CONCAT('Su ticket con id ', NEW.id_ticket, ' ha sido llegado a los técnicos.\n\nTítulo: ', NEW.asunto, '\n\nMensaje: ', NEW.descripcion),
      0
    );
  END IF;
END$$

DELIMITER ;
